From de9f52984d7638957e7741643ab4a8fa74b5f96f Mon Sep 17 00:00:00 2001
From: Chaomin Zheng <chaomin.zheng@amlogic.com>
Date: Sat, 29 Sep 2018 15:24:48 +0800
Subject: [PATCH] Audiopolicy:adjust spdif hdmi_arc policy[1/4]

PD# 315

adjust spdif hdmi_arc policy

Change-Id: I5117e4376e0e3eab1298a00758ac765993812af3
---
 services/audiopolicy/common/include/Volume.h      |  8 +++++-
 services/audiopolicy/enginedefault/src/Engine.cpp | 31 +++++++++++++++++++++--
 2 files changed, 36 insertions(+), 3 deletions(-)

diff --git a/services/audiopolicy/common/include/Volume.h b/services/audiopolicy/common/include/Volume.h
index fc012a2..f30d0a2 100644
--- a/services/audiopolicy/common/include/Volume.h
+++ b/services/audiopolicy/common/include/Volume.h
@@ -81,7 +81,13 @@ public:
             // retain the device on the A2DP output as the other must not correspond to an active
             // selection if not the speaker.
             //  - HDMI-CEC system audio mode only output: give priority to available item in order.
-            if (device & AUDIO_DEVICE_OUT_SPEAKER) {
+            if (device & AUDIO_DEVICE_OUT_ALL_A2DP) {
+                device = (audio_devices_t)(device & AUDIO_DEVICE_OUT_ALL_A2DP);
+            } else if (device & AUDIO_DEVICE_OUT_ALL_SCO) {
+                device = (audio_devices_t)(device & AUDIO_DEVICE_OUT_ALL_SCO);
+            } else if (device & AUDIO_DEVICE_OUT_ALL_USB) {
+                device = (audio_devices_t)(device & AUDIO_DEVICE_OUT_ALL_USB);
+            } else if (device & AUDIO_DEVICE_OUT_SPEAKER) {
                 device = AUDIO_DEVICE_OUT_SPEAKER;
             } else if (device & AUDIO_DEVICE_OUT_SPEAKER_SAFE) {
                 device = AUDIO_DEVICE_OUT_SPEAKER_SAFE;
diff --git a/services/audiopolicy/enginedefault/src/Engine.cpp b/services/audiopolicy/enginedefault/src/Engine.cpp
index e998d5f..bf60df5 100644
--- a/services/audiopolicy/enginedefault/src/Engine.cpp
+++ b/services/audiopolicy/enginedefault/src/Engine.cpp
@@ -29,6 +29,7 @@
 #include <AudioPort.h>
 #include <IOProfile.h>
 #include <policy.h>
+#include <cutils/properties.h>
 #include <utils/String8.h>
 #include <utils/Log.h>
 
@@ -533,6 +534,15 @@ audio_devices_t Engine::getDeviceForStrategyInt(routing_strategy strategy,
             (mForceUse[AUDIO_POLICY_FORCE_FOR_MEDIA] == AUDIO_POLICY_FORCE_SPEAKER)) {
             device2 = availableOutputDevicesType & AUDIO_DEVICE_OUT_SPEAKER;
         }
+        //changed by amlogic for force spdif/hdmi-arc audio output
+        if ((device2 == AUDIO_DEVICE_NONE) &&
+            (mForceUse[AUDIO_POLICY_FORCE_FOR_MEDIA] == AUDIO_POLICY_FORCE_HDMI_ARC)) {
+            device2 = availableOutputDevicesType & AUDIO_DEVICE_OUT_HDMI_ARC;
+        }
+        if ((device2 == AUDIO_DEVICE_NONE) &&
+            (mForceUse[AUDIO_POLICY_FORCE_FOR_MEDIA] == AUDIO_POLICY_FORCE_SPDIF)) {
+            device2 = availableOutputDevicesType & AUDIO_DEVICE_OUT_SPDIF;
+        }
         if (device2 == AUDIO_DEVICE_NONE) {
             device2 = availableOutputDevicesType & AUDIO_DEVICE_OUT_WIRED_HEADPHONE;
         }
@@ -569,7 +579,11 @@ audio_devices_t Engine::getDeviceForStrategyInt(routing_strategy strategy,
         if (strategy == STRATEGY_MEDIA) {
             // ARC, SPDIF and AUX_LINE can co-exist with others.
             device3 = availableOutputDevicesType & AUDIO_DEVICE_OUT_HDMI_ARC;
-            device3 |= (availableOutputDevicesType & AUDIO_DEVICE_OUT_SPDIF);
+            //modified by amlogic,if SPDIF are co-exist with others.
+            //device3 |= (availableOutputDevicesType & AUDIO_DEVICE_OUT_SPDIF);
+            if (property_get_int32("ro.vendor.platform.is.tv", 0) == 0) {
+                device3 |= (availableOutputDevicesType & AUDIO_DEVICE_OUT_SPDIF);
+            }
             device3 |= (availableOutputDevicesType & AUDIO_DEVICE_OUT_AUX_LINE);
         }
 
@@ -579,10 +593,23 @@ audio_devices_t Engine::getDeviceForStrategyInt(routing_strategy strategy,
         device |= device2;
 
         // If hdmi system audio mode is on, remove speaker out of output list.
-        if ((strategy == STRATEGY_MEDIA) &&
+        //modified by amlogic,if HDMI ARC are co-exist with AUDIO_DEVICE_OUT_SPEAKER
+        /* if ((strategy == STRATEGY_MEDIA) &&
             (mForceUse[AUDIO_POLICY_FORCE_FOR_HDMI_SYSTEM_AUDIO] ==
                 AUDIO_POLICY_FORCE_HDMI_SYSTEM_AUDIO_ENFORCED)) {
             device &= ~AUDIO_DEVICE_OUT_SPEAKER;
+        } */
+        bool hasBluetoothOrUsbDevices = (device & AUDIO_DEVICE_OUT_BLUETOOTH_A2DP) ||
+                (device & AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES) ||
+                (device & AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER) ||
+                (device & AUDIO_DEVICE_OUT_BLUETOOTH_SCO) ||
+                (device & AUDIO_DEVICE_OUT_BLUETOOTH_SCO_CARKIT) ||
+                (device & AUDIO_DEVICE_OUT_BLUETOOTH_SCO_HEADSET) ||
+                (device & AUDIO_DEVICE_OUT_USB_HEADSET) ||
+                (device & AUDIO_DEVICE_OUT_USB_ACCESSORY) ||
+                (device & AUDIO_DEVICE_OUT_USB_DEVICE);
+        if ((strategy == STRATEGY_MEDIA) && hasBluetoothOrUsbDevices) {
+            device &= ~AUDIO_DEVICE_OUT_HDMI_ARC;
         }
 
         // for STRATEGY_SONIFICATION:
-- 
1.9.1

